# 80端口重定向到443
server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$host$request_uri;
}



server {
    listen 443 ssl;
    server_name yourdomain.com;  # 你的域名

    ssl_certificate /etc/nginx/ssl/yourdomain.com-fullchain.cer; # 证书链文件
    ssl_certificate_key /etc/nginx/ssl/yourdomain.com.key; # 私钥文件

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # --- 前端静态资源服务 ---
    # 设置前端静态文件目录
    root /usr/share/nginx/html_ns;
    index index.html;

    # 为 Vite 构建的 /assets 目录添加一个专门的 location 块。
    # 这可以防止对 JS/CSS 等资源的请求错误地回退到 index.html，并允许我们为其设置更合适的缓存策略。
    # 因为这个 location 更具体，它会优先于 "location /" 被匹配。
    location /assets/ {
        # 为静态资源设置长期缓存，因为它们的文件名中通常带有哈希值，内容改变时文件名也会改变。
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location / {
        try_files $uri $uri/ /index.html;  # 支持前端路由
    }

    # --- not_stone-backend API 代理 ---
    location /not_stone_api/ {
        proxy_pass http://not_stone-backend:3004/;  # 转发到后端服务
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # --- 安全配置 ---
    add_header X-Content-Type-Options nosniff; # 防止浏览器进行 MIME 类型嗅探
    add_header X-XSS-Protection "1; mode=block";# 启用浏览器的 XSS 防御功能（主要用于旧浏览器,现代浏览器已内置 XSS 防护）
    add_header X-Frame-Options "DENY";# 禁止被其他网站嵌入, 防止点击劫持

    # --- gzip 压缩 ---
    gzip on;
    
    # 设置压缩级别（1-9，数字越大压缩率越高，但 CPU 消耗也越大）
    gzip_comp_level 6;
    
    # 设置压缩的最小文件大小
    gzip_min_length 1k;
    
    # 设置压缩缓冲区大小
    gzip_buffers 4 16k;
    
    # 设置压缩的 HTTP 版本
    gzip_http_version 1.1;
    
    # 设置压缩的 MIME 类型
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/x-httpd-php
        image/jpeg
        image/gif
        image/png
        image/svg+xml;
    
    # 是否在 HTTP/1.0 请求中启用 gzip
    gzip_proxied any;
    
    # 添加 Vary 头，告诉代理服务器根据 Accept-Encoding 头缓存不同版本
    gzip_vary on;
    
    # 禁用 IE6 及以下版本的 gzip
    gzip_disable "MSIE [1-6]\.";
}